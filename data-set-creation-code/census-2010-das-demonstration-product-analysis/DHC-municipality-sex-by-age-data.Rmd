---
title: 'Analysis of 2010 DAS Demonstration Product Data for Municipalities: Sex by Age'
date: 'May 16, 2023'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, fig.width = 10)

library(tidyverse)
library(keyring)
library(plotly)
library(kableExtra)
library(skimr)

downloads_path <- key_get("downloads_path")
#key_set(downloads_path)   #if not already stored, store your downloads path using keyring


```

## Background and Data Sources

In 2020 and 2021, the Census Bureau released several data products meant to demonstrate the effect of the Bureau's new Disclosure Avoidance System (DAS) on population counts (using 2010 census data). The final demonstration product using the same privacy parameters applied to the 2020 census data was released in September 2023 for sex by age. The University of Minnesotaâ€™s IPUMS National Historical Geographic Information System (NHGIS) volunteered to convert the Census Bureau's un-tabulated demonstration data into useful summary formats, linked to the published 2010 summary data. The intent of both organizations was for census data users to use these tabulated files to assess the impact of the DAS on their own local data.  NHGIS tabulated data is located [here](https://www.nhgis.org/privacy-protected-2010-census-demonstration-data#v20210608-files). Information on the DAS is located [here](https://www.census.gov/programs-surveys/decennial-census/decade/2020/planning-management/process/disclosure-avoidance/2020-das-development.html).

Note: Chicago is excluded due to being OOJ.

<hr>
<br>

```{r muni_cleaning, eval = T, include=FALSE}

#Source file: NHGIS Vintage 2022-08-25 Nationwide Files Place

#Target variables: P12 is sex by age  
#        H76001:      Total
#        H76002:      Male
#        H76003:      Male: Under 5 years
#        H76016:      Male: 50 to 54 years
#        H76025:      Male: 85 years and over
#        H76026:      Female
#        H76027:      Female: Under 5 years
#        H76040:      Female: 50 to 54 years
#        H76049:      Female: 85 years and over
#        demonstration product variables are appended "_dp", published 2010 variables are appended "_sf"

#Download zipped file of places data
#download.file("https://assets.nhgis.org/differential-privacy/v20220825/nhgis_ppdd_20220825_p_place.zip", paste0(downloads_path, "places.zip"))

#Unzip file
#unzip(paste0(downloads_path, "places.zip"), exdir = sub("\\/$", "", downloads_path))

#Import places data set, filter to Illinois and target variables
places <- read_csv(paste0(downloads_path, "nhgis_ppdd_20220825_p_place.csv")) %>%
  filter(state == 17) %>%
  select(geocode,
         name,
         total_pop_dp = H76001_dp,
         total_pop_sf = H76001_sf,
         total_male_dp = H76002_dp,
         total_male_sf = H76002_sf,
         male_young_dp = H76003_dp,
         male_young_sf = H76003_sf,
         male_fifties_dp = H76016_dp,
         male_fifties_sf = H76016_sf,
         male_old_dp = H76025_dp,
         male_old_sf = H76025_sf,
         total_female_dp = H76026_dp,
         total_female_sf = H76026_sf,
         female_young_dp = H76027_dp,
         female_young_sf = H76027_sf,
         female_fifties_dp = H76040_dp,
         female_fifties_sf = H76040_sf,
         female_old_dp = H76049_dp,
         female_old_sf = H76049_sf
) %>%
  mutate(geocode=gsub('17','',geocode)) %>%
  rename(CensusPlaceCode=geocode)

#Import 2010 CCDPH muni file
munis <- read_csv("https://raw.githubusercontent.com/Cook-County-Department-of-Public-Health/ccdph-data-sets/main/2010/Municipality%20Populations.csv") 

#Filter places dataset to CCDPH munis using census place code
places <- places %>%
  right_join(munis)

#write function to calculate changes
# change<- function(dp)
# {
#   dp_string=deparse(substitute(dp))
#   sf_string=gsub('dp','sf',dp_string)
#   sf=eval(parse(text=sf_string))
#   dp-sf
# }
# perc_change<- function(dp)
# {
#   dp_string=deparse(substitute(dp))
#   sf_string=gsub('dp','sf',dp_string)
#   sf=eval(parse(text=sf_string))
#   round((dp-sf)/sf*100,2)
# }

#Calculate absolute change and percent change for all variables of interest
muni_comparison <- places %>%
  mutate(
         totalpop_change=total_pop_dp-total_pop_sf,
         perc_totalpop_change=round((total_pop_dp-total_pop_sf)/total_pop_sf*100,2),
         total_malepop_change=total_male_dp-total_male_sf,
         perc_total_malepop_change=round((total_male_dp-total_male_sf)/total_male_sf*100,2),
         male_young_change=male_young_dp-male_young_sf,
         perc_male_young_change=round((male_young_dp-male_young_sf)/male_young_sf*100,2),
         male_fifties_change=male_fifties_dp-male_fifties_sf,
         perc_male_fifties_change=round((male_fifties_dp-male_fifties_sf)/male_fifties_sf*100,2),
         male_old_change=male_old_dp-male_old_sf,
         perc_male_old_change=round((male_old_dp-male_old_sf)/male_old_sf*100,2),
         total_femalepop_change=total_female_dp-total_female_sf,
         perc_total_femalepop_change=round((total_female_dp-total_female_sf)/total_female_sf*100,2),
         female_young_change=female_young_dp-female_young_sf,
         perc_female_young_change=round((female_young_dp-female_young_sf)/female_young_sf*100,2),
         female_fifties_change=female_fifties_dp-female_fifties_sf,
         perc_female_fifties_change=round((female_fifties_dp-female_fifties_sf)/female_fifties_sf*100,2),
         female_old_change=female_old_dp-female_old_sf,
         perc_female_old_change=round((female_old_dp-female_old_sf)/female_old_sf*100,2),
      across(contains("change"), abs, .names = "abs_{col}")
    )
muni_comparison<-muni_comparison[!(muni_comparison$Municipality=="Chicago"),]

#Summary stats
mean(muni_comparison$totalpop_change,na.rm=TRUE) #mean change (no concerns for directionality)
max(muni_comparison$abs_totalpop_change,na.rm=TRUE) #largest absolute change of all munis
mean(muni_comparison$perc_totalpop_change,na.rm=TRUE) #mean percent change (no concerns for directionality)
max(muni_comparison$abs_perc_totalpop_change,na.rm=TRUE) #largest absolute percent change of all munis
```

## Total Municipality Population

The mean absolute change in population between the published 2010 data and the demonstration product data is **-0.56 people**. The largest absolute change in population between the demonstration data and the actual 2010 data is for Hoffman Estates with an increase of **18 people** in the demonstration data. The mean percent change in population for all Cook County towns is **0.007%**. There are **0** towns with a percent change in total population of more than 5%. The town with the largest absolute percent change in the demonstration total population counts is Bedford Park with a percent change of **0.52%**. These patterns are reflected in the box plots below.

<br>

**Conclusions: Total municipality populations are unlikely to be largely impacted by the 2020 DAS parameters and can be used without reservation.**

<br>

```{r total_muni_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_totalpop_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_totalpop_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Total Municipality Population",
         showlegend = FALSE
        )

```

<br>

```{r total_muni_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_totalpop_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_totalpop_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Total Municipality Population by District",
         showlegend = FALSE
        )

```

<hr>
<br>

```{r total_male,eval=F}

#Summary stats
mean(muni_comparison$abs_total_malepop_change,na.rm = TRUE)  #average absolute change in number of males
max(muni_comparison$abs_total_malepop_change,na.rm = TRUE) #greatest abs change in number of males
mean(muni_comparison$perc_total_malepop_change,na.rm = TRUE) #average percent change in number of males, directionality
max(muni_comparison$abs_perc_total_malepop_change,na.rm=TRUE) #greatest abs percent change in number of males
summary(muni_comparison$perc_total_malepop_change)
```
```{r include=FALSE}
total_male_outliers <- muni_comparison %>%
  filter(abs_perc_total_malepop_change >= 5) %>%
  select(Municipality, total_pop_sf, total_male_sf, total_male_dp, perc_total_malepop_change)

```

## Total Male Population for Municipality, regardless of Age

The mean absolute change in the total male population by municipality between the published 2010 data and the demonstration product data is **5.29 people**. The largest absolute change in population is for Chicago Heights, with an increase of **23 people** in the demonstration data. The mean percent change in the total male population for all Cook County munis is **-0.02%**. There are **no** towns with a percent change in the total male population of more than 5%. The town with the largest percent change in the demonstration Hispanic/Latino population counts is McCook with a percent change of **-1.85%**. The median percent change is **0%** and the interquartile range is **[-1.04%, 0.82%]**.

<br>

**Conclusions: When aggregated, the variation introduced by the DAS settings for the total male population at the municipal level is negligible. There are no concerns for directionality. This means we can be reasonably confident in the 2020 jurisdiction-level total male population estimate, as calculated by the subtraction method.**

<br>

```{r total_male_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_total_malepop_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_total_malepop_change),
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Total Male Population for Municipality",
         showlegend = FALSE
        )
```

<br>

```{r total_male_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_total_malepop_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_total_malepop_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Total Male Population by District",
         showlegend = FALSE
        )

```

<hr>
<br>
```{r total_female,eval=FALSE}

#Summary stats
mean(muni_comparison$abs_total_femalepop_change,na.rm = TRUE)  #average absolute change in number of females
max(muni_comparison$abs_total_femalepop_change,na.rm = TRUE) #greatest abs change in number of females
mean(muni_comparison$perc_total_femalepop_change,na.rm = TRUE) #average percent change in number of females, directionality
max(muni_comparison$abs_perc_total_femalepop_change,na.rm=TRUE) #greatest abs percent change in females
summary(muni_comparison$perc_total_femalepop_change)
```
```{r include=FALSE}
total_female_outliers <- muni_comparison %>%
  filter(abs_perc_total_femalepop_change >= 5) %>%
  select(Municipality, total_pop_sf, total_female_sf, total_female_dp, perc_total_femalepop_change)

```

## Total Female Population for Municipality, regardless of Age

The mean absolute change in the total female population by municipality between the published 2010 data and the demonstration product data is **6.68 people**. The largest absolute change in population is for Chicago Heights, with a decrease of **33 people** in the demonstration data. The mean percent change in the total female population for all Cook County munis is **-0.03%**. There are **no** towns with a percent change in the total female population of more than 5%. The town with the largest percent change in the demonstration female population counts is McCook with a percent change of **2.5%**. The median percent change is **0%** and the interquartile range is **[-0.07%, 0.05%]**.

<br>

**Conclusions: When aggregated, the variation introduced by the DAS settings for the total female population at the municipal level is negligible. There are no concerns for directionality. This means we can be reasonably confident in the 2020 jurisdiction-level total female population estimate, as calculated by the subtraction method.**

<br>

```{r total_female_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_total_femalepop_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_total_femalepop_change),
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Total Female Population for Municipality",
         showlegend = FALSE
        )
```

<br>

```{r total_female_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_total_femalepop_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_total_femalepop_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Total Female Population by District",
         showlegend = FALSE
        )
```
<hr>
<br>
```{r male_young,eval=FALSE}

#Summary stats
mean(muni_comparison$abs_male_young_change,na.rm = TRUE)
max(muni_comparison$abs_male_young_change,na.rm = TRUE)
mean(muni_comparison$perc_male_young_change,na.rm = TRUE)
max(muni_comparison$abs_perc_male_young_change,na.rm=TRUE)
summary(muni_comparison$perc_male_young_change)
```
```{r include=FALSE}
total_male_young_outliers <- muni_comparison %>%
  filter(abs_perc_male_young_change >= 5) %>%
  select(Municipality, total_pop_sf, male_young_sf, male_young_dp, perc_male_young_change)
```

## Males under 5 years of age by Municipality

The mean absolute change in the male population under 5 years of age by municipality between the published 2010 data and the demonstration product data is **4.17 people**. The largest absolute change in population is for Elgin, with an increase of **23 people** in the demonstration data. The mean percent change in the male population under 5 years for all Cook County munis is **0.15%**. There are **6** towns with a percent change in the male population under 5 years of more than 5%. The town with the largest absolute percent change in the demonstration population counts is Forest View with a percent change of **33.33%**. The median percent change is **0%** and the interquartile range is **[-0.77%, 0.79%]**.

<br>

**Conclusions: When aggregated, the variation introduced by the DAS settings for the male population under 5 years of age at the municipal level largely balances out. There are no concerns for directionality. This means we can be reasonably confident in the 2020 jurisdiction-level male population under 5 years estimate, as calculated by the subtraction method. However, at the individual municipality level, 4% of municipalities have percent changes in population outside acceptable bounds. As expected, outliers are more common in areas where either the total population is smaller or the young male population is low. While this is notable and something to be wary about, it is not an overarching issue for a majority of municipalities.**

<br>

```{r total_male_young_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_male_young_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_male_young_change),
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Male Population Under 5 Years for Municipality",
         showlegend = FALSE
        )
```

<br>

```{r total_male_young_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_male_young_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_male_young_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Male Population Under 5 Years by District",
         showlegend = FALSE
        )
```
<br>
```{r male_young_outliers, echo=FALSE}
total_male_young_outliers %>%
  arrange(perc_male_young_change) %>%
  kable(caption = "Towns with >5% Change in Male Population Under 5 Years", col.names = c("Municipality", "Published Total", "Published", "Demonstration", "Percent Change")) %>%
  kable_styling()
```
<hr>
<br>
```{r male_fifties,eval=FALSE}

#Summary stats
mean(muni_comparison$abs_male_fifties_change,na.rm = TRUE)
max(muni_comparison$abs_male_fifties_change,na.rm = TRUE)
mean(muni_comparison$perc_male_fifties_change,na.rm = TRUE)
max(muni_comparison$abs_perc_male_fifties_change,na.rm=TRUE)
summary(muni_comparison$perc_male_fifties_change)
```
```{r include=FALSE}
total_male_fifties_outliers <- muni_comparison %>%
  filter(abs_perc_male_fifties_change >= 5) %>%
  select(Municipality, total_pop_sf, male_fifties_sf, male_fifties_dp, perc_male_fifties_change)

```

## Males 50-54 Years by Municipality

The mean absolute change in the male population 50-54 years of age by municipality between the published 2010 data and the demonstration product data is **4 people**. The largest absolute change in population is for Elgin, with a decrease of **16 people** in the demonstration data. The mean percent change in the male population 50-54 years for all Cook County munis is **-0.02%**. There are **4** towns with a percent change in the male population 50-54 years of more than 5%. The town with the largest absolute percent change in the demonstration population counts is Forest View with a percent change of **-10%**. The median percent change is **0%** and the interquartile range is **[-0.64%, 0.68%]**.

<br>

**Conclusions: When aggregated, the variation introduced by the DAS settings for the male population 50-54 years of age at the municipal level largely balances out. There are no concerns for directionality. This means we can be reasonably confident in the 2020 jurisdiction-level male population 50-54 years estimate, as calculated by the subtraction method. However, at the individual municipality level, 3% of municipalities have percent changes in population outside acceptable bounds. As expected, outliers are more common in areas where either the total population is smaller or the middle-aged male population is low. While this is notable and something to be wary about, it is not an overarching issue for a majority of municipalities.**

<br>

```{r total_male_fifties_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_male_fifties_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_male_fifties_change),
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Male Population 50-54 Years for Municipality",
         showlegend = FALSE
        )
```

<br>

```{r total_male_fifties_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_male_fifties_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_male_fifties_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Male Population 50-54 Years by District",
         showlegend = FALSE
        )
```
<br>
```{r male_fifties_outliers, echo=FALSE}
total_male_fifties_outliers %>%
  arrange(perc_male_fifties_change) %>%
  kable(caption = "Towns with >5% Change in Male Population 50-54 Years", col.names = c("Municipality", "Published Total", "Published", "Demonstration", "Percent Change")) %>%
  kable_styling()
```
<hr>
<br>
```{r male_old,eval=FALSE}

#Summary stats
mean(muni_comparison$abs_male_old_change,na.rm = TRUE)
max(muni_comparison$abs_male_old_change,na.rm = TRUE)
mean(muni_comparison$perc_male_old_change,na.rm = TRUE)
max(muni_comparison$abs_perc_male_old_change,na.rm=TRUE)
summary(muni_comparison$perc_male_old_change)
```
```{r include=FALSE}
total_male_old_outliers <- muni_comparison %>%
  filter(abs_perc_male_old_change >= 5) %>%
  select(Municipality, total_pop_sf, male_old_sf, male_old_dp, perc_male_old_change) %>%
  arrange(perc_male_old_change)
total_male_old_outliers<-total_male_old_outliers[1:10,]

```

## Males 85+ Years by Municipality

The mean absolute change in the male population 85 years and older by municipality between the published 2010 data and the demonstration product data is **4 people**. The largest absolute change in population is for Hanover Park, with an increase of **20 people** in the demonstration data. The mean percent change in the male population 85 years and older for all Cook County munis is **4.26%**. There are **55** towns with a percent change in the male population 85 years and older of more than 5%. The town with the largest absolute percent change in the demonstration population counts is East Hazel Crest with a percent change of **233.33%**. The median percent change is **0.21%** and the interquartile range is **[-2.95%, 4.27%]**.

<br>

**Conclusions: When aggregated, the variation introduced by the DAS settings for the male population 85 years and older at the municipal level is quite unstable. There are no concerns for directionality. However, this means we cannot be very confident in the 2020 jurisdiction-level male population 85 years and older estimate, as calculated by the subtraction method. At the individual municipality level, 40% of municipalities have percent changes in population outside acceptable bounds. As expected, outliers are more common in areas where either the total population is smaller or the older male population is low, which is not uncommon. Calculation of rates for the 85+ male population at the municipal level should be advised against for some municipalities. When rates must be calculated, strong data caveats should be included. Alternatively, a minimum population threshold of 500 or 1000 could be applied, below which rates would be censored.**

<br>

```{r total_male_old_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_male_old_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_male_old_change),
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Male Population 85 years and older for Municipality",
         showlegend = FALSE
        )
```

<br>

```{r total_male_old_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_male_old_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_male_old_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Male Population 85 years and older by District",
         showlegend = FALSE
        )
```
<br>
```{r male_old_outliers, echo=FALSE}
total_male_old_outliers %>%
  arrange(perc_male_old_change) %>%
  kable(caption = "Towns with >5% Change in Male Population 85 years and older", col.names = c("Municipality", "Published Total", "Published", "Demonstration", "Percent Change")) %>%
  kable_styling()
```
<hr>
<br>
```{r female_young,eval=FALSE}

#Summary stats
mean(muni_comparison$abs_female_young_change,na.rm = TRUE)
max(muni_comparison$abs_female_young_change,na.rm = TRUE)
mean(muni_comparison$perc_female_young_change,na.rm = TRUE)
max(muni_comparison$abs_perc_female_young_change,na.rm=TRUE)
summary(muni_comparison$perc_female_young_change)
```
```{r include=FALSE}
total_female_young_outliers <- muni_comparison %>%
  filter(abs_perc_female_young_change >= 5) %>%
  select(Municipality, total_pop_sf, female_young_sf, female_young_dp, perc_female_young_change)

```

## Females under 5 years of age by Municipality

The mean absolute change in the female population under 5 years of age by municipality between the published 2010 data and the demonstration product data is **4.51 people**. The largest absolute change in population is for Evanston, with a decrease of **21 people** in the demonstration data. The mean percent change in the female population under 5 years for all Cook County munis is **-0.03%**. There are **10** towns with a percent change in the female population under 5 years of more than 5%. The town with the largest absolute percent change in the demonstration population counts is Forest View with a percent change of **19.05%**. The median percent change is **-0.07%** and the interquartile range is **[-0.96%, 0.65%]**.

<br>

**Conclusions: When aggregated, the variation introduced by the DAS settings for the female population under 5 years of age at the municipal level largely balances out. There are no concerns for directionality. This means we can be reasonably confident in the 2020 jurisdiction-level female population under 5 years estimate, as calculated by the subtraction method. However, at the individual municipality level, 7% of municipalities have percent changes in population outside acceptable bounds. As expected, outliers are more common in areas where either the total population is smaller or the young female population is low. While this is notable and something to be wary about, it is not an overarching issue for a majority of municipalities.**

<br>

```{r total_female_young_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_female_young_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_female_young_change),
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Female Population Under 5 Years for Municipality",
         showlegend = FALSE
        )
```

<br>

```{r total_female_young_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_female_young_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_female_young_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Female Population Under 5 Years by District",
         showlegend = FALSE
        )
```
<br>
```{r female_young_outliers, echo=FALSE}
total_female_young_outliers %>%
  arrange(perc_female_young_change) %>%
  kable(caption = "Towns with >5% Change in Female Population Under 5 Years", col.names = c("Municipality", "Published Total", "Published", "Demonstration", "Percent Change")) %>%
  kable_styling()
```
<hr>
<br>
```{r female_fifties,eval=FALSE}

#Summary stats
mean(muni_comparison$abs_female_fifties_change,na.rm = TRUE)
max(muni_comparison$abs_female_fifties_change,na.rm = TRUE)
mean(muni_comparison$perc_female_fifties_change,na.rm = TRUE)
max(muni_comparison$abs_perc_female_fifties_change,na.rm=TRUE)
summary(muni_comparison$perc_female_fifties_change)
```
```{r include=FALSE}
total_female_fifties_outliers <- muni_comparison %>%
  filter(abs_perc_female_fifties_change >= 5) %>%
  select(Municipality, total_pop_sf, female_fifties_sf, female_fifties_dp, perc_female_fifties_change)

```

## Females 50-54 Years by Municipality

The mean absolute change in the female population 50-54 years of age by municipality between the published 2010 data and the demonstration product data is **3.81 people**. The largest absolute change in population is for Evanston, with an increase of **18 people** in the demonstration data. The mean percent change in the female population 50-54 years for all Cook County munis is **0.55%**. There are **5** towns with a percent change in the female population 50-54 years of more than 5%. The town with the largest absolute percent change in the demonstration population counts is McCook with a percent change of **66.67%**. The median percent change is **0%** and the interquartile range is **[-0.45%, 0.51%]**.

<br>

**Conclusions: When aggregated, the variation introduced by the DAS settings for the female population 50-54 years of age at the municipal level largely balances out. There are no concerns for directionality. This means we can be reasonably confident in the 2020 jurisdiction-level female population 50-54 years estimate, as calculated by the subtraction method. However, at the individual municipality level, 4% of municipalities have percent changes in population outside acceptable bounds. As expected, outliers are more common in areas where either the total population is smaller or the middle-aged female population is low. While this is notable and something to be wary about, it is not an overarching issue for a majority of municipalities.**

<br>

```{r total_female_fifties_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_female_fifties_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_female_fifties_change),
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Female Population 50-54 Years for Municipality",
         showlegend = FALSE
        )
```

<br>

```{r total_female_fifties_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_female_fifties_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_female_fifties_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Female Population 50-54 Years by District",
         showlegend = FALSE
        )
```
<br>
```{r female_fifties_outliers, echo=FALSE}
total_female_fifties_outliers %>%
  arrange(perc_female_fifties_change) %>%
  kable(caption = "Towns with >5% Change in Female Population 50-54 Years", col.names = c("Municipality", "Published Total", "Published", "Demonstration", "Percent Change")) %>%
  kable_styling()
```
<hr>
<br>
```{r female_old,eval=FALSE}

#Summary stats
mean(muni_comparison$abs_female_old_change,na.rm = TRUE)
max(muni_comparison$abs_female_old_change,na.rm = TRUE)
mean(muni_comparison$perc_female_old_change,na.rm = TRUE)
max(muni_comparison$abs_perc_female_old_change,na.rm=TRUE)
summary(muni_comparison$perc_female_old_change)
```
```{r include=FALSE}
total_female_old_outliers <- muni_comparison %>%
  filter(abs_perc_female_old_change >= 5) %>%
  select(Municipality, total_pop_sf, female_old_sf, female_old_dp, perc_female_old_change) %>%
  arrange(perc_female_old_change)
total_female_old_outliers<-total_female_old_outliers[1:10,]

```

## Females 85+ Years by Municipality

The mean absolute change in the female population 85 years and older by municipality between the published 2010 data and the demonstration product data is **5 people**. The largest absolute change in population is for both Mount Prospect and Tinley Park, both with a decrease of **17 people** in the demonstration data. The mean percent change in the female population 85 years and older for all Cook County munis is **2.06%**. There are **34** towns with a percent change in the female population 85 years and older of more than 5%. The town with the largest absolute percent change in the demonstration population counts is Golf with a percent change of **50%**. The median percent change is **0.34%** and the interquartile range is **[-1.56%, 4.27%]**.

<br>

**Conclusions: When aggregated, the variation introduced by the DAS settings for the female population 85 years and older at the municipal level is quite unstable. There are no concerns for directionality. At the individual municipality level, 25% of municipalities have percent changes in population outside acceptable bounds. This is better for the male population at the same age, and so we can cautiously use the 2020 jurisdiction-level female population 85 years and older estimate, as calculated by the subtraction method.  As expected, outliers are more common in areas where either the total population is smaller or the older female population is low, which is not uncommon. Calculation of rates for the 85+ female population at the municipal level should be advised against for some municipalities. When rates must be calculated, strong data caveats should be included. Alternatively, a minimum population threshold of 500 or 1000 could be applied, below which rates would be censored.**

<br>

```{r total_female_old_perplot, echo=FALSE}
#Plot percent change
plot_ly(muni_comparison, y = ~perc_female_old_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0,
        text = ~paste("Muni: ", Municipality,"<br>", "Percent Change: ", perc_female_old_change),
        hoverinfo = "text") %>%
  layout(xaxis = list(title=""),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Female Population 85 years and older for Municipality",
         showlegend = FALSE
        )
```

<br>

```{r total_female_old_district, echo=FALSE}

#Plot percent change by district
plot_ly(muni_comparison, y = ~perc_female_old_change, type = "box", 
        boxpoints = "all", jitter = 0.3, pointpos = 0, color = ~District,
        text = ~paste("Town: ", Municipality,"<br>", "Percent Change: ", perc_female_old_change), 
        hoverinfo = "text") %>%
  layout(xaxis = list(title="SCC District"),
         yaxis = list(title="Percent Change"),
         title = "Percent Change in Female Population 85 years and older by District",
         showlegend = FALSE
        )
```
<br>
```{r female_old_outliers, echo=FALSE}
total_female_old_outliers %>%
  arrange(perc_female_old_change) %>%
  kable(caption = "Towns with >5% Change in Female Population 85 years and older", col.names = c("Municipality", "Published Total", "Published", "Demonstration", "Percent Change")) %>%
  kable_styling()
```
