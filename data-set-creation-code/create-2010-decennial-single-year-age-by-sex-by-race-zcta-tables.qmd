---
title: "CCDPH EPI UNIT DATA MANAGEMENT"
subtitle: "<u>2010 DECENNIAL DATA BY SINGLE-YEAR AGE, SEX, RACE, ZCTA</u>: <i>Steps for creating 2010 decennial population counts for rate denominators</i>"
date: "`r format(Sys.time(), '%d %B %Y')`"
  
format:
  html:
    code-tools: false  
    code-fold: false
    echo: true
    eval: false
    warning: false
    toc: true
    toc-depth: 3
    toc-location: left
    reference-location: document
    fig-cap-location: top
    fig-height: 2.75
    fontsize: 0.9em
    interlinespace: -0.75em
    embed-resources: true
editor_options: 
  chunk_output_type: console
---

# activate required packages
```{r}
library(censusapi)
library(DBI)
library(odbc)
library(tigris) 
library(tidyverse)
library(tidyr)
library(dplyr) 
library(sf)
library(data.table)
library(keyring)
```

# connect to inter-census and inter-spatial SQL Server databases, add reference tables
```{r}
con_inter_census <- dbConnect(odbc::odbc(),
                               Driver   = "SQL Server",
                               Server   = key_get("ccdph_sql_server"),
                               Database = "inter-census")

# read census age groups from database
census_standard_age_groups <-  dbReadTable(conn = con_inter_census, 
               Id(schema="ref", 
                  table="standard-age-groups"))

# read zcta table from database
zctas_cook_county <- dbReadTable(conn = con_inter_census, 
               Id(schema="ref", table="decennial-2010-total-by-zcta")) %>% 
  mutate(geoid_zcta = as.character(geoid_zcta))

```

# review 2010 decennial census APIs, groups and variables
```{r}
# return all census 2010 APIs
allCensusApis_df <- listCensusApis() %>% filter(vintage=="2010")

# return all groups in census 2020 demographic and housing counts
groups_census_2010_sf1 <- listCensusMetadata(
  name = "dec/sf1",
  vintage = 2010,
  type = "groups",
  group = NULL,
  variable_name = NULL,
  include_values = FALSE
)

# select all PCT12 (age, sex, race) groups
groups_age_sex_race <- groups_census_2010_sf1 %>%
  select(name, description) %>%
  filter(str_detect(name, "PCT12")) %>%
  distinct() %>%
  arrange(name)

# return all variables in census 2020 demographic and housing counts
variables_census_2010_sf1 <- listCensusMetadata(
  name = "dec/sf1",
  vintage = 2010,
  type = "variables",
  group = NULL,
  variable_name = NULL,
  include_values = FALSE
)

```

# create detailed age, sex, and race variable tables and lists
```{r}
# select all PCT12 (age, sex) variables
variables_age_sex_race <- variables_census_2010_sf1 %>%
  select(name, label) %>%
  filter(str_detect(name, "PCT012")) %>%
  distinct() %>%
  arrange(name)

variables_age_groups <- variables_age_sex_race %>%
  filter(str_detect(name, "PCT012A")) %>%
  mutate(col_number = as.integer(substr(name,8,10)),
         label = str_replace_all(label, " !!Total!!Male",""),
         label = str_replace_all(label, "Total!!Male!!",""),
         label = str_replace_all(label, "Total!!Female!!",""),
         label = str_replace_all(label, "!!","")) %>%
  select(-name, name_age_1yr = label)

variables_age_groups_mod <- variables_age_groups %>% 
  left_join(census_standard_age_groups, by="name_age_1yr") %>% drop_na(order_age_1yr)

# groups used for data tables
# name	description
# PCT12A	SEX BY SINGLE-YEAR AGE (WHITE ALONE)
# PCT12B	SEX BY SINGLE-YEAR AGE (BLACK OR AFRICAN AMERICAN ALONE)
# PCT12C	SEX BY SINGLE-YEAR AGE (AMERICAN INDIAN AND ALASKA NATIVE ALONE)
# PCT12D	SEX BY SINGLE-YEAR AGE (ASIAN ALONE)
# PCT12E	SEX BY SINGLE-YEAR AGE (NATIVE HAWAIIAN AND OTHER PACIFIC ISLANDER ALONE)
# PCT12F	SEX BY SINGLE-YEAR AGE (SOME OTHER RACE ALONE)
# PCT12G	SEX BY SINGLE-YEAR AGE (TWO OR MORE RACES)
# PCT12H	SEX BY SINGLE-YEAR AGE (HISPANIC OR LATINO)
# PCT12I	SEX BY SINGLE-YEAR AGE (WHITE ALONE, NOT HISPANIC OR LATINO)
# PCT12J	SEX BY SINGLE-YEAR AGE (BLACK OR AFRICAN AMERICAN ALONE, NOT HISPANIC OR LATINO)
# PCT12K	SEX BY SINGLE-YEAR AGE (AMERICAN INDIAN AND ALASKA NATIVE ALONE, NOT HISPANIC OR LATINO)
# PCT12L	SEX BY SINGLE-YEAR AGE (ASIAN ALONE, NOT HISPANIC OR LATINO)
# PCT12M	SEX BY SINGLE-YEAR AGE (NATIVE HAWAIIAN AND OTHER PACIFIC ISLANDER ALONE, NOT HISPANIC OR LATINO)
# PCT12N	SEX BY SINGLE-YEAR AGE (SOME OTHER RACE ALONE, NOT HISPANIC OR LATINO)
# PCT12O	SEX BY SINGLE-YEAR AGE (TWO OR MORE RACES, NOT HISPANIC OR LATINO)
```

# Download variables for partial zctas (zctas partially inside Cook County)
```{r}
# create list subset of partial zctas
zctas_cook_county_partial_df <- as.list(zctas_cook_county %>% filter(partial==1 & pop_in_cook > 0) %>%  select(geoid_zcta))

zctas_cook_county_partial <- zctas_cook_county_partial_df$geoid_zcta

# Download variables by census tract
grouplist <- c("PCT12H", "PCT12I", "PCT12J", "PCT12K", "PCT12L","PCT12M","PCT12N","PCT12O")

groupname <- c("Hispanic", "NH White", "NH Black", "NH AIAN", "NH Asian","NH NHPI","NH Other","NH Multiracial")

#groupname <- c("Hispanic", "Non-Hispanic White", "Non-Hispanic Black", "Non-Hispanic Native American or Alaskan Native", "Non-Hispanic Asian","Non-Hispanic Native Hawaiian or Other Pacific Islander","Non-Hispanic Other","Non-Hispanic Two or More Races")

ayear <- 2010

for (agroup in grouplist) {
  for (azcta_partial in  zctas_cook_county_partial) {
    agroupname = paste("group(",agroup,")",sep="")
    agroup_mod <- str_replace(agroup,"PCT","PCT0")
    aregion = paste0("county (or part):031")
    aregionin = paste0("state:17 zip code tabulation area (or part):", as.character(azcta_partial))
    print(agroupname)
    print(aregionin)
    census_group <- getCensus(name = "dec/sf1",
                           vintage = ayear,
                           vars = c(agroupname),
                           region = aregion,
                           regionin=aregionin,
                           key=key_get("census_api_key"))
    census_group <- census_group %>% 
      select(-ends_with("NA")) %>%
      mutate(census_group = agroup,
             vintage = ayear,
             source = "https://api.census.gov/data/2010/dec/sf1") %>%
      rename_with(~str_replace(.,agroup_mod,"age_"))
    assign(paste(agroup,"zcta_partial",azcta_partial, ayear,sep="_"),census_group)
  }
}

# bind partial zcta tables
apattern <- paste("_zcta_partial_")
alist_pattern <- mget(ls(pattern = apattern))
zctas_partial_single_age_sex_race_2010 <- bind_rows(alist_pattern)  %>%
  rename(geoid_zcta = zip_code_tabulation_area_or_part) %>%
  select(-c(county_or_part, NAME, GEO_ID, state))

# remove partial muni tables from environment
rm(list=ls(pattern="_zcta_partial_"))
```

# Download variables for all zctas
```{r}
ayear <- 2010

for (agroup in grouplist) {
  agroupname = paste("group(", agroup, ")", sep = "")
  agroup_mod <- str_replace(agroup, "PCT", "PCT0")
  print(agroupname)
  census_group <- getCensus(
    name = "dec/sf1",
    vintage = ayear,
    vars = c(agroupname),
   region = "zip code tabulation area (or part):*",
   regionin = "state:17",  
    key = key_get("census_api_key")
   )
   census_group <- census_group %>%
    select(-ends_with("NA")) %>%
    mutate(census_group = agroup,
           vintage = ayear,
           source = "https://api.census.gov/data/2010/dec/sf1") %>%
    rename_with( ~ str_replace(., agroup_mod, "age_"))
  assign(paste(agroup, "zctas_all", ayear, sep = "_"),
         census_group)
}

# bind total other zcta tables
apattern <- paste("_zctas_all_")
alist_pattern <- mget(ls(pattern = apattern))

# create comprehensive zcta table with total populations
zctas_total_single_age_sex_race_2010 <- bind_rows(alist_pattern) %>%
  rename(geoid_zcta = zip_code_tabulation_area_or_part) %>%  
  right_join(zctas_cook_county %>% select(geoid_zcta), by="geoid_zcta") %>% 
  drop_na(GEO_ID) %>% 
  select(-c(state, GEO_ID, NAME))

# create comprehensive zcta table with total populations 
# and partial places removed
zctas_nopartial_single_age_sex_race_2010 <- zctas_total_single_age_sex_race_2010 %>%
  anti_join(zctas_partial_single_age_sex_race_2010, by="geoid_zcta")

# remove total muni tables from environment
rm(list=ls(pattern="_zctas_all_"))
```

# Bind partial and total zcta population tables
```{r}
# bind partial and non-partial muni tables
zctas_withpartial_single_age_sex_race_2010 <- zctas_nopartial_single_age_sex_race_2010 %>% bind_rows(zctas_partial_single_age_sex_race_2010)

group_list <- as.data.frame(grouplist) %>% rename(census_group = 1)
group_category <- as.data.frame(groupname) %>% rename(race = 1)
group_categories <- bind_cols(group_list, group_category)

# reformat partial and non-partial zcta tables
zctas_withpartial_single_age_sex_race_2010_attr <- zctas_withpartial_single_age_sex_race_2010 %>%
  select(geoid_zcta, vintage, source, census_group, starts_with("age")) %>% 
  left_join(group_categories, by = "census_group") %>%
  pivot_longer(cols=c(age_001:age_209), names_to = "age_sex", values_to = "population") %>%
  mutate(col_number = as.integer(substr(age_sex,5,7)),
         sex = case_when(col_number == 1 ~ "Total",
                   col_number > 2 & col_number <=105 ~ "Male",
                   col_number > 106 & col_number <=209 ~ "Female")) %>%
  left_join(variables_age_groups_mod, by="col_number") %>%
  filter(col_number >= 3, col_number != 106) %>%
  left_join(zctas_cook_county %>% select(geoid_zcta, partial), by="geoid_zcta") %>%
  select(geoid_zcta,
         name_age_1yr:order_age_10yr,
         sex,
         race,
         pop_in_cook = population,
         vintage, 
         source) %>%
  arrange(geoid_zcta,
          sex,
          race,
          order_age_1yr)

# reformat total population zcta table
zctas_total_single_age_sex_race_2010_attr <- zctas_total_single_age_sex_race_2010 %>%
  select(geoid_zcta, vintage, source, census_group, starts_with("age")) %>% 
  left_join(group_categories, by = "census_group") %>%
  pivot_longer(cols=c(age_001:age_209), names_to = "age_sex", values_to = "population") %>%
  mutate(col_number = as.integer(substr(age_sex,5,7)),
         sex = case_when(col_number == 1 ~ "Total",
                   col_number > 2 & col_number <=105 ~ "Male",
                   col_number > 106 & col_number <=209 ~ "Female")) %>%
  left_join(variables_age_groups_mod, by="col_number") %>%
  filter(col_number >= 3, col_number != 106) %>%
  arrange(geoid_zcta,
          sex,
          race,
          col_number) %>%
  select(geoid_zcta, sex, race, name_age_1yr:order_age_10yr, population, vintage, source)

# add total population column to with partial table
zctas_comp_single_age_sex_race_2010_attr <- zctas_withpartial_single_age_sex_race_2010_attr %>%
  left_join(zctas_total_single_age_sex_race_2010_attr %>% select(geoid_zcta,name_age_1yr,sex,race,pop_total = population), by=c("geoid_zcta", "name_age_1yr", "sex","race")) %>% 
  relocate(pop_total, .after = pop_in_cook)
```

# write table inter-census SQL Server database
```{r}
con_inter_census <- dbConnect(odbc::odbc(),
                               Driver   = "SQL Server",
                               Server   = key_get("ccdph_sql_server"),
                               Database = "inter-census")

dbWriteTable(conn = con_inter_census, 
               Id(schema="ref", table="decennial-2010-single-year-age-sex-race-ethnicity-by-zcta"), 
               overwrite= TRUE,
               zctas_comp_single_age_sex_race_2010_attr)

write_csv(zctas_comp_single_age_sex_race_2010_attr, "C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-data-sets/2010/decennial-2010-single-year-age-sex-race-by-zcta.csv")

```


